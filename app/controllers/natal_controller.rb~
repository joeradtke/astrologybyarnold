class NatalController < ApplicationController
  def new
    @natal=Natal.new
    @birthplace=Birthplace.all
  end

  def create
    @birth=Birth.new(natal_params)
    @birthto=@birth
    @birthplace=Birthplace.find(natal_params[:id])
    @birth=adjust_time(@birth,@birthplace)
    @timezone=@birthplace.timezone
    @pageintro=Page.where('name=?','introduction').first
    @pageinfl=Page.where('name=?','influence').first
    @pageasp=Page.where('name=?','aspects').first
    out=eph(@birth,@birthplace)
    @out=out
    long=long(out)
    speed=speed(out)
    house=house(out)
    hc=hc(out)
    @hc=hc
    name=Digest::SHA1.hexdigest(Time.now.to_s)
    @image="#{name}.jpg"
    name2=Digest::SHA2.hexdigest(Time.now.to_s)
    @image2="#{name2}.jpg"
    create_image(@image,long,house,hc)
    aspects=create_aspect_grid(@image2,long,hc)
    ascend=find_ascendant_sign(hc[0])
    @ascendant=Ascendant.where('sign_no=?',ascend)
    @planets=[]
    @houses=[]
    (0..9).each do |i|
      p=Planet.new
      p.longitude=convert_longitude(long[i])
      p.house=house[i].to_f.floor
      h=House.new
      h.longitude=convert_longitude(hc[i])
      @planets.push(p)
      @houses.push(h)
    end
    @planetsigns=[]
    @planethouses=[]
    (0..9).each do |i|
      sign=(long[i].to_f/30).floor
      ps=Planetsign.where("planetno=? AND signno=?",i,sign).first
      if ps!=nil
        @planetsigns.push(ps)
      end
      ph=Planethouse.where("planetno=? AND houseno=?",i,@planets[i].house).first
      if ph!=nil
        @planethouses.push(ph)
      end
    end
  end

  def natal_params
    params.require(:natal).permit(:name,:date,:city,:id)
  end
end
